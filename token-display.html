<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Live Queue Display | Dr. Harikrishna – KIN</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
<style>
:root{
  --green:#1a6b4a;--gd:#0e4730;--gl:#2a8c62;
  --gold:#c8963e;--gold-l:#f5d08a;
  --cream:#faf7f2;--dark:#1a1a1a;--text:#3a3a3a;--muted:#7a7a7a;
  --r:16px;
  --bg:#07200f;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;}
body{
  font-family:'DM Sans',sans-serif;
  background:var(--bg);
  color:#fff;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
h1,h2,h3,h4,.serif{font-family:'Playfair Display',serif;}
.mono{font-family:'DM Mono',monospace;}

/* ─── HEADER ─── */
header{
  background:linear-gradient(135deg,var(--gd),var(--green));
  padding:.9rem 2rem;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid rgba(255,255,255,.08);
  flex-shrink:0;
}
.brand{font-family:'Playfair Display',serif;font-size:1.1rem;color:#fff;font-weight:700;}
.brand span{display:block;font-size:.6rem;font-family:'DM Sans',sans-serif;letter-spacing:.15em;text-transform:uppercase;color:var(--gold-l);font-weight:400;margin-top:2px;}
.header-right{display:flex;align-items:center;gap:1.5rem;}
.live-badge{display:flex;align-items:center;gap:.5rem;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.3);border-radius:50px;padding:.3rem .9rem;font-size:.72rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:#4ade80;}
.live-dot{width:7px;height:7px;border-radius:50%;background:#22c55e;animation:pulse 1.5s infinite;}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,.5);}50%{box-shadow:0 0 0 6px rgba(34,197,94,0);}}
#clock{font-family:'DM Mono',monospace;font-size:1.05rem;color:var(--gold-l);letter-spacing:.08em;}
#date-str{font-size:.72rem;color:rgba(255,255,255,.4);text-align:right;margin-top:2px;letter-spacing:.04em;}

/* ─── MAIN LAYOUT ─── */
.stage{
  flex:1;
  display:grid;
  grid-template-columns:1fr 380px;
  grid-template-rows:auto 1fr;
  gap:1.5rem;
  padding:1.5rem 2rem 1.5rem;
  overflow:hidden;
}

/* ─── NOW SERVING ─── */
.now-serving{
  grid-column:1;grid-row:1;
  background:linear-gradient(135deg,rgba(26,107,74,.25),rgba(14,71,48,.4));
  border:1px solid rgba(26,107,74,.35);
  border-radius:20px;
  padding:2rem 2.5rem;
  display:flex;align-items:center;gap:2rem;
  position:relative;overflow:hidden;
}
.now-serving::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse at 0% 50%,rgba(200,150,62,.07) 0%,transparent 60%);
  pointer-events:none;
}
.ns-label{font-size:.7rem;font-weight:700;letter-spacing:.15em;text-transform:uppercase;color:var(--gold);margin-bottom:.5rem;}
.ns-token{
  font-family:'Playfair Display',serif;
  font-size:clamp(3.5rem,7vw,5.5rem);
  font-weight:700;color:var(--gold-l);
  line-height:1;
  text-shadow:0 0 40px rgba(200,150,62,.3);
  transition:all .4s ease;
}
.ns-divider{width:2px;height:80px;background:rgba(255,255,255,.08);flex-shrink:0;}
.ns-info{flex:1;}
.ns-name{font-size:clamp(1rem,2vw,1.35rem);font-weight:700;color:#fff;margin-bottom:.3rem;}
.ns-meta{font-size:.8rem;color:rgba(255,255,255,.45);}
.ns-session-pill{
  display:inline-flex;align-items:center;gap:.4rem;
  background:rgba(200,150,62,.15);border:1px solid rgba(200,150,62,.3);
  border-radius:50px;padding:.3rem .9rem;font-size:.72rem;color:var(--gold-l);font-weight:600;
  margin-top:.6rem;
}
.calling-anim{
  position:absolute;right:2rem;top:50%;transform:translateY(-50%);
  display:flex;align-items:center;gap:4px;
}
.calling-anim span{
  display:block;width:4px;border-radius:4px;background:var(--gold);
  animation:bars .8s ease-in-out infinite;
}
.calling-anim span:nth-child(1){height:16px;animation-delay:0s;}
.calling-anim span:nth-child(2){height:28px;animation-delay:.1s;}
.calling-anim span:nth-child(3){height:20px;animation-delay:.2s;}
.calling-anim span:nth-child(4){height:32px;animation-delay:.3s;}
.calling-anim span:nth-child(5){height:22px;animation-delay:.15s;}
@keyframes bars{0%,100%{transform:scaleY(.5);opacity:.4;}50%{transform:scaleY(1);opacity:1;}}

/* ─── UP NEXT ─── */
.up-next{
  grid-column:1;grid-row:2;
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.07);
  border-radius:20px;
  padding:1.5rem;
  overflow:hidden;
  display:flex;flex-direction:column;
}
.section-title{
  font-size:.68rem;font-weight:700;letter-spacing:.15em;text-transform:uppercase;
  color:rgba(255,255,255,.35);margin-bottom:1rem;display:flex;align-items:center;gap:.5rem;
}
.section-title::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.06);}
.queue-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:.7rem;
  flex:1;overflow-y:auto;
}
.queue-grid::-webkit-scrollbar{width:4px;}
.queue-grid::-webkit-scrollbar-track{background:transparent;}
.queue-grid::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:4px;}
.q-card{
  background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.07);
  border-radius:14px;padding:.9rem;
  transition:all .2s;
  position:relative;overflow:hidden;
}
.q-card.pos-1{background:rgba(26,107,74,.18);border-color:rgba(26,107,74,.4);}
.q-pos{font-size:.6rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(255,255,255,.3);margin-bottom:.3rem;}
.q-card.pos-1 .q-pos{color:var(--gl);}
.q-tok{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;color:var(--gold-l);line-height:1;}
.q-name{font-size:.78rem;color:rgba(255,255,255,.5);margin-top:.25rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.q-badge{position:absolute;top:.6rem;right:.6rem;font-size:.58rem;font-weight:700;padding:.15rem .45rem;border-radius:50px;}
.q-badge.pri{background:rgba(239,68,68,.15);color:#fca5a5;border:1px solid rgba(239,68,68,.2);}
.q-badge.norm{display:none;}
.no-queue{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  color:rgba(255,255,255,.18);gap:.5rem;
}
.no-queue i{font-size:2.5rem;}
.no-queue p{font-size:.85rem;}

/* ─── SIDEBAR ─── */
.sidebar{
  grid-column:2;grid-row:1/3;
  display:flex;flex-direction:column;gap:1.2rem;
  overflow-y:auto;
}
.sidebar::-webkit-scrollbar{width:3px;}
.sidebar::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);}

.stat-card{
  background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);
  border-radius:18px;padding:1.4rem;
}
.stat-row{display:flex;gap:1rem;}
.stat-item{flex:1;text-align:center;}
.stat-val{
  font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:700;
  color:#fff;line-height:1;
}
.stat-val.green{color:#4ade80;}
.stat-val.gold{color:var(--gold-l);}
.stat-lbl{font-size:.65rem;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.1em;margin-top:.35rem;}
.stat-divider{width:1px;background:rgba(255,255,255,.07);align-self:stretch;}

.sessions-card{
  background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);
  border-radius:18px;padding:1.4rem;flex:1;
  display:flex;flex-direction:column;
}
.sess-list{display:flex;flex-direction:column;gap:.65rem;flex:1;}
.sess-item{
  background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);
  border-radius:12px;padding:.8rem 1rem;
  display:flex;align-items:center;gap:.7rem;
  transition:border-color .2s;
}
.sess-item.active-sess{border-color:rgba(26,107,74,.5);background:rgba(26,107,74,.1);}
.sess-item.active-sess .sess-dot{background:#4ade80;box-shadow:0 0 8px rgba(74,222,128,.5);}
.sess-dot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.15);flex-shrink:0;}
.sess-info{flex:1;min-width:0;}
.sess-name{font-size:.8rem;font-weight:600;color:rgba(255,255,255,.75);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sess-time{font-size:.65rem;color:rgba(255,255,255,.3);margin-top:2px;}
.sess-count{
  font-family:'DM Mono',monospace;
  font-size:.78rem;font-weight:500;color:rgba(255,255,255,.4);
  background:rgba(255,255,255,.06);
  border-radius:6px;padding:.15rem .45rem;white-space:nowrap;flex-shrink:0;
}
.sess-item.active-sess .sess-count{color:var(--gold-l);background:rgba(200,150,62,.12);}

/* ─── TICKER ─── */
.ticker{
  flex-shrink:0;
  background:rgba(200,150,62,.08);border-top:1px solid rgba(200,150,62,.15);
  padding:.6rem 2rem;
  display:flex;align-items:center;gap:1rem;
  overflow:hidden;
}
.ticker-label{
  font-size:.65rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;
  color:var(--gold);white-space:nowrap;flex-shrink:0;
  display:flex;align-items:center;gap:.4rem;
}
.ticker-label::after{content:'';display:block;width:1px;height:14px;background:rgba(200,150,62,.3);}
.ticker-track{flex:1;overflow:hidden;position:relative;height:20px;}
.ticker-inner{
  position:absolute;white-space:nowrap;
  font-size:.78rem;color:rgba(255,255,255,.45);
  animation:ticker 28s linear infinite;
  top:50%;transform:translateY(-50%);
}
@keyframes ticker{0%{transform:translateX(100%) translateY(-50%);}100%{transform:translateX(-100%) translateY(-50%);}}

/* ─── TOKEN FLASH OVERLAY ─── */
#call-overlay{
  position:fixed;inset:0;background:rgba(7,32,15,.92);
  z-index:999;display:none;
  flex-direction:column;align-items:center;justify-content:center;
  gap:1rem;
}
#call-overlay.show{display:flex;animation:fadein .25s ease;}
@keyframes fadein{from{opacity:0;transform:scale(.96);}to{opacity:1;transform:scale(1);}}
.overlay-lbl{font-size:.85rem;font-weight:700;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);}
.overlay-tok{font-family:'Playfair Display',serif;font-size:clamp(6rem,15vw,11rem);font-weight:700;color:var(--gold-l);line-height:1;text-shadow:0 0 80px rgba(200,150,62,.4);}
.overlay-name{font-size:clamp(1.2rem,3vw,2rem);color:rgba(255,255,255,.7);font-weight:300;}
.overlay-sess{font-size:.9rem;color:rgba(255,255,255,.35);margin-top:.5rem;}
.overlay-bar{width:200px;height:4px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden;margin-top:1.5rem;}
.overlay-prog{height:100%;background:var(--gold);border-radius:4px;animation:prog 3.5s linear forwards;}
@keyframes prog{from{width:0;}to{width:100%;}}

/* ─── RESPONSIVE ─── */
@media(max-width:900px){
  .stage{grid-template-columns:1fr;grid-template-rows:auto auto 1fr;}
  .now-serving{grid-column:1;grid-row:1;}
  .sidebar{grid-column:1;grid-row:2;flex-direction:row;flex-wrap:wrap;}
  .stat-card,.sessions-card{flex:1;min-width:220px;}
  .up-next{grid-column:1;grid-row:3;}
}
@media(max-width:500px){
  .stage{padding:1rem;}
  header{padding:.7rem 1rem;}
  .ns-token{font-size:3.5rem;}
}

.kin-status{position:fixed;top:4.5rem;right:1rem;z-index:9999;padding:.28rem .75rem;border-radius:50px;font-size:.65rem;font-weight:600;box-shadow:0 2px 10px rgba(0,0,0,.25);display:flex;align-items:center;gap:.35rem;}
.kin-status::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor;}
.kin-status-ok{background:rgba(22,163,74,.2);color:#4ade80;border:1px solid rgba(74,222,128,.2);}
.kin-status-info{background:rgba(3,105,161,.2);color:#7dd3fc;border:1px solid rgba(125,211,252,.2);}
.kin-status-warn{background:rgba(180,83,9,.2);color:#fcd34d;border:1px solid rgba(252,211,77,.2);}
.kin-status-err{background:rgba(185,28,28,.2);color:#fca5a5;border:1px solid rgba(252,165,165,.2);}
</style>
</head>
<body>

<!-- TOKEN CALL OVERLAY -->
<div id="call-overlay">
  <div class="overlay-lbl">Now Calling</div>
  <div class="overlay-tok" id="ov-tok">--</div>
  <div class="overlay-name" id="ov-name">--</div>
  <div class="overlay-sess" id="ov-sess">--</div>
  <div class="overlay-bar"><div class="overlay-prog"></div></div>
</div>

<!-- HEADER -->
<header>
  <div class="brand">Krishna Institute of Naturopathy<span>Dr. Harikrishna · Mangalore</span></div>
  <div class="header-right">
    <div class="live-badge"><div class="live-dot"></div>Live Queue</div>
    <div>
      <div id="clock">--:--:--</div>
      <div id="date-str">--</div>
    </div>
  </div>
<div id="kin-sync-status" class="kin-status kin-status-info">Live</div>
</header>

<!-- MAIN STAGE -->
<div class="stage">

  <!-- NOW SERVING -->
  <div class="now-serving">
    <div>
      <div class="ns-label"><i class="bi bi-person-check-fill" style="margin-right:.35rem"></i>Now Serving</div>
      <div class="ns-token" id="ns-tok">--</div>
    </div>
    <div class="ns-divider"></div>
    <div class="ns-info">
      <div class="ns-name" id="ns-name">Waiting for patients…</div>
      <div class="ns-meta" id="ns-meta">&nbsp;</div>
      <div class="ns-session-pill" id="ns-sess-pill" style="display:none"><i class="bi bi-clock"></i><span id="ns-sess">--</span></div>
    </div>
    <div class="calling-anim" id="calling-anim" style="display:none">
      <span></span><span></span><span></span><span></span><span></span>
    </div>
  </div>

  <!-- UP NEXT QUEUE -->
  <div class="up-next">
    <div class="section-title"><i class="bi bi-list-ol"></i>Waiting Queue</div>
    <div id="queue-container">
      <div class="no-queue" id="no-queue">
        <i class="bi bi-inbox"></i>
        <p>No patients in queue</p>
      </div>
      <div class="queue-grid" id="queue-grid" style="display:none"></div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <!-- Stats -->
    <div class="stat-card">
      <div class="section-title" style="margin-bottom:.9rem"><i class="bi bi-bar-chart-fill"></i>Today's Stats</div>
      <div class="stat-row">
        <div class="stat-item">
          <div class="stat-val green" id="st-wait">0</div>
          <div class="stat-lbl">Waiting</div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
          <div class="stat-val gold" id="st-done">0</div>
          <div class="stat-lbl">Seen</div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
          <div class="stat-val" id="st-total">0</div>
          <div class="stat-lbl">Total</div>
        </div>
      </div>
    </div>

    <!-- Avg wait -->
    <div class="stat-card">
      <div class="section-title" style="margin-bottom:.9rem"><i class="bi bi-hourglass-split"></i>Estimated Wait</div>
      <div style="text-align:center;">
        <div style="font-family:'Playfair Display',serif;font-size:2.6rem;font-weight:700;color:var(--gold-l);" id="est-wait">--</div>
        <div style="font-size:.65rem;color:rgba(255,255,255,.3);letter-spacing:.1em;text-transform:uppercase;margin-top:.3rem;">minutes for next token</div>
      </div>
    </div>

    <!-- Sessions -->
    <div class="sessions-card">
      <div class="section-title" style="margin-bottom:.9rem"><i class="bi bi-calendar3"></i>Sessions Today</div>
      <div class="sess-list" id="sess-list"></div>
    </div>
  </div>
</div>

<!-- TICKER -->
<div class="ticker">
  <div class="ticker-label"><i class="bi bi-info-circle"></i>Notice</div>
  <div class="ticker-track">
    <div class="ticker-inner" id="ticker-text">
      Please maintain silence in the waiting area &nbsp;·&nbsp; Keep your token slip ready &nbsp;·&nbsp; Kindly inform reception if you need to leave &nbsp;·&nbsp; Emergency cases will be prioritised &nbsp;·&nbsp; Dr. Harikrishna · +91 96114 11652 &nbsp;·&nbsp; Nadigudde, Valpady Post, Mangalore
    </div>
  </div>
</div>

<script>
/* ── KIN CLOUD SYNC ─── */
var KIN_CONFIG = {
  SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxl4feNbV8AxAvSzj-4vq2BmkfMurQRYDsk-MDRMF9CXzfrn8s2RknUyL1XETJETWmK/exec', // ← PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE
  SYNC_INTERVAL: 5000,
};
var _KIN={tokens:null,sessions:null,online:false};
function _kinShowStatus(msg,type){var el=document.getElementById('kin-sync-status');if(!el)return;el.textContent=msg;el.className='kin-status kin-status-'+(type||'info');}
function _kinFetch(url,opts){return fetch(url,opts).then(function(r){return r.json();}).catch(function(e){return{error:e.toString()};});}
function getTokens(){if(_KIN.tokens!==null)return _KIN.tokens;try{return JSON.parse(localStorage.getItem('kin_tokens'))||[];}catch(e){return[];}}
function getSessions(){if(_KIN.sessions!==null)return _KIN.sessions;var D=[{id:'AM1',name:'Morning Session 1',time:'9:00 AM - 11:00 AM',icon:'bi-brightness-high-fill',cap:30,avg:4},{id:'AM2',name:'Morning Session 2',time:'11:00 AM - 1:00 PM',icon:'bi-sun-fill',cap:25,avg:5},{id:'PM1',name:'Afternoon Session',time:'2:00 PM - 4:00 PM',icon:'bi-cloud-sun-fill',cap:25,avg:5},{id:'PM2',name:'Evening Session',time:'4:00 PM - 6:00 PM',icon:'bi-moon-stars-fill',cap:20,avg:6}];try{return JSON.parse(localStorage.getItem('kin_sessions'))||D;}catch(e){return D;}}
function saveTokens(arr){_KIN.tokens=arr;localStorage.setItem('kin_tokens',JSON.stringify(arr));}
function kinPull(cb){
  if(!KIN_CONFIG.SCRIPT_URL){if(cb)cb();return;}
  _KIN.online=true;_kinShowStatus('Live','info');
  Promise.all([_kinFetch(KIN_CONFIG.SCRIPT_URL+'?action=getTokens'),_kinFetch(KIN_CONFIG.SCRIPT_URL+'?action=getSessions')]).then(function(res){
    if(res[0]&&res[0].ok){_KIN.tokens=res[0].tokens||[];localStorage.setItem('kin_tokens',JSON.stringify(_KIN.tokens));}
    if(res[1]&&res[1].ok&&res[1].sessions&&res[1].sessions.length){_KIN.sessions=res[1].sessions;localStorage.setItem('kin_sessions',JSON.stringify(_KIN.sessions));}
    _kinShowStatus('Live','ok');if(cb)cb();
  }).catch(function(){_kinShowStatus('Offline','err');if(cb)cb();});
}
/* ── END SYNC ─── */

(function(){
var TKEY='kin_tokens', SKEY='kin_sessions';
var DEFAULT_SESSIONS=[
  {id:'AM1',name:'Morning Session 1',time:'9:00 AM – 11:00 AM',icon:'bi-brightness-high-fill',cap:30,avg:4},
  {id:'AM2',name:'Morning Session 2',time:'11:00 AM – 1:00 PM', icon:'bi-sun-fill',            cap:25,avg:5},
  {id:'PM1',name:'Afternoon Session', time:'2:00 PM – 4:00 PM', icon:'bi-cloud-sun-fill',      cap:25,avg:5},
  {id:'PM2',name:'Evening Session',   time:'4:00 PM – 6:00 PM', icon:'bi-moon-stars-fill',     cap:20,avg:6}
];
var PRIORITY_COLORS={Critical:'#fca5a5',Pregnant:'#f9a8d4','Senior Citizen':'#fde68a','Differently Abled':'#93c5fd',Child:'#a5f3fc'};

/* getSessions / getTokens provided by KIN sync layer */
function todayStr(){return new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});}

/* Clock */
function updateClock(){
  var now=new Date();
  var h=now.getHours(),m=now.getMinutes(),s=now.getSeconds();
  var ampm=h>=12?'PM':'AM';
  h=h%12||12;
  document.getElementById('clock').textContent=
    String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')+' '+ampm;
  document.getElementById('date-str').textContent=
    now.toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
}
setInterval(updateClock,1000);updateClock();

/* Previous serving token for flash detection */
var prevServingId=null;

function render(){
  var tday=todayStr();
  var toks=getTokens().filter(function(t){return t.date===tday;});
  var ss=getSessions();
  var serving=null,waiting=[],done=0;
  for(var i=0;i<toks.length;i++){
    if(toks[i].status==='serving') serving=toks[i];
    else if(toks[i].status==='waiting') waiting.push(toks[i]);
    else if(toks[i].status==='done') done++;
  }

  /* Flash overlay when a new token is being served */
  if(serving && serving.id!==prevServingId){
    prevServingId=serving.id;
    showOverlay(serving);
  }
  if(!serving) prevServingId=null;

  /* Now Serving */
  var nsTok=document.getElementById('ns-tok');
  var nsName=document.getElementById('ns-name');
  var nsMeta=document.getElementById('ns-meta');
  var nsPill=document.getElementById('ns-sess-pill');
  var nsSess=document.getElementById('ns-sess');
  var callingAnim=document.getElementById('calling-anim');

  if(serving){
    nsTok.textContent=serving.tokenNum;
    nsName.textContent=serving.name;
    nsMeta.textContent=(serving.age?serving.age+'y · ':'')+serving.condition+(serving.priority&&serving.priority!=='None'?' · ⚑ '+serving.priority:'');
    nsSess.textContent=serving.sessionName;
    nsPill.style.display='inline-flex';
    callingAnim.style.display='flex';
  } else {
    nsTok.textContent='--';
    nsName.textContent='No one is being served right now';
    nsMeta.innerHTML='&nbsp;';
    nsPill.style.display='none';
    callingAnim.style.display='none';
  }

  /* Waiting queue grid */
  var qGrid=document.getElementById('queue-grid');
  var noQ=document.getElementById('no-queue');
  if(waiting.length===0){
    qGrid.style.display='none';noQ.style.display='flex';
  } else {
    qGrid.style.display='grid';noQ.style.display='none';
    qGrid.innerHTML='';
    for(var j=0;j<waiting.length;j++){
      var t=waiting[j];
      var pri=t.priority&&t.priority!=='None';
      var col=pri?(PRIORITY_COLORS[t.priority]||'#fde68a'):'';
      var c=document.createElement('div');
      c.className='q-card'+(j===0?' pos-1':'');
      c.innerHTML=
        '<div class="q-pos">'+(j===0?'Next Up':'#'+(j+1))+'</div>'+
        '<div class="q-tok">'+t.tokenNum+'</div>'+
        '<div class="q-name">'+t.name.split(' ')[0]+'</div>'+
        (pri?'<div class="q-badge pri" style="color:'+col+';border-color:'+col+'40;background:'+col+'18">'+t.priority+'</div>':'');
      qGrid.appendChild(c);
    }
  }

  /* Stats */
  document.getElementById('st-wait').textContent=waiting.length;
  document.getElementById('st-done').textContent=done;
  document.getElementById('st-total').textContent=toks.length;

  /* Est wait */
  var avgMin=ss[0]?ss[0].avg:5;
  if(serving) for(var k=0;k<ss.length;k++){if(ss[k].id===serving.sessionId){avgMin=ss[k].avg;break;}}
  document.getElementById('est-wait').textContent=waiting.length>0?(waiting.length*avgMin):'0';

  /* Sessions sidebar */
  var sessListEl=document.getElementById('sess-list');
  sessListEl.innerHTML='';
  for(var m=0;m<ss.length;m++){
    var s=ss[m];
    var cnt=toks.filter(function(t){return t.sessionId===s.id&&t.status==='waiting';}).length;
    var serv=(serving&&serving.sessionId===s.id);
    var d=document.createElement('div');
    d.className='sess-item'+(serv?' active-sess':'');
    d.innerHTML=
      '<div class="sess-dot"></div>'+
      '<div class="sess-info"><div class="sess-name">'+s.name+'</div><div class="sess-time">'+s.time+'</div></div>'+
      '<div class="sess-count">'+cnt+' waiting</div>';
    sessListEl.appendChild(d);
  }
}

function showOverlay(token){
  var ov=document.getElementById('call-overlay');
  document.getElementById('ov-tok').textContent=token.tokenNum;
  document.getElementById('ov-name').textContent=token.name;
  document.getElementById('ov-sess').textContent=token.sessionName||'Please proceed to the consultation room';
  /* Restart progress bar */
  var bar=ov.querySelector('.overlay-prog');
  if(bar){bar.style.animation='none';bar.offsetWidth;bar.style.animation='prog 3.5s linear forwards';}
  ov.classList.add('show');
  setTimeout(function(){ov.classList.remove('show');},3600);
}

/* Cloud-aware poll */
kinPull(render);
setInterval(function(){kinPull(render);},KIN_CONFIG.SYNC_INTERVAL);

/* Also listen for storage events (cross-tab) */
window.addEventListener('storage',function(e){
  if(e.key===TKEY||e.key===SKEY) render();

  /* ── ANNOUNCEMENT from Admin ── */
  if(e.key==='kin_announce'&&e.newValue){
    try{
      var p=JSON.parse(e.newValue);
      if(p&&p.tokenNum){
        announceOnDisplay(p.tokenNum,p.name||'');
      }
    }catch(err){}
  }
});

/* ─── SPEECH ANNOUNCEMENT (female voice) ─── */
function announceOnDisplay(tokenNum,name){
  /* Show flash overlay */
  showOverlay({tokenNum:tokenNum,name:name,sessionName:''});

  if(!window.speechSynthesis) return;
  window.speechSynthesis.cancel();

  var numPart=tokenNum.replace('T-','').replace(/^0+/,'');
  var text='Token number '+numPart+'. '+name+', please proceed to the consultation room. Token number '+numPart+'.';

  var utter=new SpeechSynthesisUtterance(text);
  utter.rate=0.85;
  utter.pitch=1.15;
  utter.volume=1;
  utter.lang='en-IN';

  function pickFemaleVoice(){
    var voices=window.speechSynthesis.getVoices();
    var femaleNames=['Samantha','Victoria','Karen','Moira','Tessa','Veena','Zira','Susan','Heera','Raveena','Aditi','Lekha'];
    var v=null;
    for(var i=0;i<voices.length;i++){if(voices[i].lang&&voices[i].lang.indexOf('en-IN')>-1&&voices[i].name.toLowerCase().indexOf('female')>-1){v=voices[i];break;}}
    if(!v)for(var i=0;i<voices.length;i++){if(voices[i].lang&&voices[i].lang.indexOf('en-IN')>-1){v=voices[i];break;}}
    if(!v)for(var i=0;i<voices.length;i++){if(voices[i].name.toLowerCase().indexOf('female')>-1){v=voices[i];break;}}
    if(!v){for(var i=0;i<voices.length;i++){for(var j=0;j<femaleNames.length;j++){if(voices[i].name.indexOf(femaleNames[j])>-1){v=voices[i];break;}}if(v)break;}}
    if(!v)for(var i=0;i<voices.length;i++){if(voices[i].lang&&voices[i].lang.indexOf('en')>-1){v=voices[i];break;}}
    return v;
  }

  function doSpeak(){
    var v=pickFemaleVoice();
    if(v) utter.voice=v;
    window.speechSynthesis.speak(utter);
  }

  if(window.speechSynthesis.getVoices().length===0){
    window.speechSynthesis.onvoiceschanged=function(){doSpeak();window.speechSynthesis.onvoiceschanged=null;};
  } else {
    doSpeak();
  }
}

/* Unlock audio context on first user interaction (required by browsers) */
document.addEventListener('click',function(){
  if(window.speechSynthesis){
    var u=new SpeechSynthesisUtterance('');
    window.speechSynthesis.speak(u);
  }
},{once:true});
})();
</script>
</body>
</html>
