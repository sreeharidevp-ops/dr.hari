<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Queue Admin | Dr. Harikrishna – KIN</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
<style>
:root{
  --green:#1a6b4a;--gd:#0e4730;--gl:#2a8c62;
  --gold:#c8963e;--gold-l:#f5d08a;
  --cream:#faf7f2;--dark:#1a1a1a;--text:#3a3a3a;--muted:#7a7a7a;
  --r:14px;
  --red:#dc2626;--amber:#d97706;--sky:#0284c7;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--text);min-height:100vh;}
h1,h2,h3,.serif{font-family:'Playfair Display',serif;}
.mono{font-family:'DM Mono',monospace;}

/* ─── TOPBAR ─── */
.topbar{
  background:linear-gradient(135deg,var(--gd),var(--green));
  padding:.85rem 1.5rem;
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:200;
  box-shadow:0 2px 20px rgba(0,0,0,.2);
}
.brand{font-family:'Playfair Display',serif;color:#fff;font-size:1rem;font-weight:700;text-decoration:none;}
.brand span{display:block;font-family:'DM Sans',sans-serif;font-weight:400;font-size:.6rem;letter-spacing:.12em;text-transform:uppercase;color:var(--gold-l);margin-top:1px;}
.topbar-right{display:flex;align-items:center;gap:.8rem;}
.nav-pill a{
  color:rgba(255,255,255,.7);text-decoration:none;font-size:.78rem;font-weight:500;
  padding:.3rem .75rem;border-radius:50px;border:1px solid transparent;transition:all .2s;
}
.nav-pill a:hover{color:#fff;border-color:rgba(255,255,255,.25);}
.nav-pill a.active{color:#fff;background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.25);}
#admin-clock{font-family:'DM Mono',monospace;font-size:.88rem;color:var(--gold-l);}

/* ─── LAYOUT ─── */
.wrap{max-width:1280px;margin:0 auto;padding:1.5rem 1.5rem 4rem;}

/* ─── STATS BAR ─── */
.stats-bar{
  display:grid;grid-template-columns:repeat(5,1fr);gap:1rem;
  margin-bottom:1.5rem;
}
@media(max-width:900px){.stats-bar{grid-template-columns:repeat(3,1fr);}}
@media(max-width:540px){.stats-bar{grid-template-columns:1fr 1fr;}}
.stat-box{
  background:#fff;border:1px solid rgba(26,107,74,.1);border-radius:var(--r);
  padding:1rem 1.2rem;box-shadow:0 2px 12px rgba(26,107,74,.05);
}
.sb-val{font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;line-height:1;color:var(--dark);}
.sb-val.green{color:var(--green);}
.sb-val.gold{color:var(--gold);}
.sb-val.red{color:var(--red);}
.sb-val.sky{color:var(--sky);}
.sb-lbl{font-size:.68rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);font-weight:600;margin-top:.3rem;}

/* ─── BODY GRID ─── */
.body-grid{display:grid;grid-template-columns:1fr 340px;gap:1.5rem;align-items:start;}
@media(max-width:960px){.body-grid{grid-template-columns:1fr;}}

/* ─── MAIN PANEL ─── */
.main-panel{}

/* ─── SESSION TABS ─── */
.sess-tabs{
  display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem;
}
.sess-tab{
  background:#fff;border:1.5px solid #e5e5e5;border-radius:50px;
  padding:.4rem 1rem;font-size:.79rem;font-weight:600;cursor:pointer;
  transition:all .18s;color:var(--muted);font-family:'DM Sans',sans-serif;
}
.sess-tab:hover{border-color:var(--green);color:var(--green);}
.sess-tab.active{background:var(--green);border-color:var(--green);color:#fff;}
.sess-tab .cnt{
  display:inline-flex;align-items:center;justify-content:center;
  min-width:18px;height:18px;border-radius:50px;
  background:rgba(255,255,255,.25);font-size:.65rem;margin-left:.35rem;padding:0 .3rem;
}
.sess-tab:not(.active) .cnt{background:rgba(26,107,74,.1);color:var(--green);}

/* ─── SERVING BAR ─── */
.serving-bar{
  background:linear-gradient(135deg,var(--gd),var(--green));
  border-radius:14px;padding:1rem 1.4rem;
  display:flex;align-items:center;gap:1.2rem;
  margin-bottom:1rem;
  position:relative;overflow:hidden;
}
.serving-bar::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 90% 50%,rgba(200,150,62,.12) 0%,transparent 60%);pointer-events:none;}
.sb-tok{font-family:'Playfair Display',serif;font-size:2.5rem;font-weight:700;color:var(--gold-l);line-height:1;min-width:80px;}
.sb-info{flex:1;}
.sb-label{font-size:.62rem;letter-spacing:.12em;text-transform:uppercase;color:rgba(255,255,255,.4);margin-bottom:.2rem;}
.sb-patient{font-size:.95rem;font-weight:700;color:#fff;}
.sb-detail{font-size:.75rem;color:rgba(255,255,255,.5);margin-top:2px;}
.sb-actions{display:flex;gap:.5rem;flex-shrink:0;flex-wrap:wrap;}
.btn-done{background:#22c55e;color:#fff;border:none;border-radius:50px;padding:.5rem 1.1rem;font-size:.8rem;font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:.35rem;font-family:'DM Sans',sans-serif;}
.btn-done:hover{background:#16a34a;transform:translateY(-1px);}
.btn-skip{background:rgba(220,38,38,.2);color:#fca5a5;border:1px solid rgba(220,38,38,.3);border-radius:50px;padding:.5rem 1.1rem;font-size:.8rem;font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:.35rem;font-family:'DM Sans',sans-serif;}
.btn-skip:hover{background:rgba(220,38,38,.35);}
.no-serving{
  background:#fff;border:1.5px dashed rgba(26,107,74,.2);border-radius:14px;
  padding:1.2rem;display:flex;align-items:center;gap:1rem;margin-bottom:1rem;
  color:var(--muted);font-size:.88rem;
}
.no-serving i{font-size:1.4rem;color:rgba(26,107,74,.2);}

/* ─── QUEUE TABLE ─── */
.card{background:#fff;border-radius:var(--r);border:1px solid rgba(26,107,74,.1);box-shadow:0 2px 16px rgba(26,107,74,.05);}
.card-head{
  padding:1rem 1.2rem;border-bottom:1px solid rgba(26,107,74,.08);
  display:flex;align-items:center;justify-content:space-between;gap:.8rem;flex-wrap:wrap;
}
.card-title{font-size:.9rem;font-weight:700;display:flex;align-items:center;gap:.5rem;color:var(--dark);}
.card-title i{color:var(--green);}
.search-box{
  display:flex;align-items:center;gap:.5rem;background:var(--cream);
  border:1.5px solid #e5e5e5;border-radius:50px;padding:.35rem .9rem;
  font-size:.8rem;transition:border-color .18s;
}
.search-box:focus-within{border-color:var(--green);}
.search-box i{color:var(--muted);}
.search-box input{border:none;background:transparent;outline:none;font-size:.8rem;font-family:'DM Sans',sans-serif;color:var(--text);width:140px;}

.queue-table{width:100%;border-collapse:collapse;}
.queue-table th{
  font-size:.65rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;
  color:var(--muted);padding:.6rem 1rem;text-align:left;
  border-bottom:1px solid #f0f0f0;background:#fafafa;
}
.queue-table td{
  padding:.7rem 1rem;border-bottom:1px solid #f8f8f8;
  font-size:.84rem;vertical-align:middle;
}
.queue-table tr:last-child td{border-bottom:none;}
.queue-table tbody tr:hover td{background:rgba(26,107,74,.02);}
.tok-badge{
  font-family:'DM Mono',monospace;font-size:.82rem;font-weight:500;
  background:rgba(26,107,74,.08);color:var(--green);
  border-radius:8px;padding:.18rem .55rem;display:inline-block;
}
.status-dot{
  display:inline-flex;align-items:center;gap:.35rem;
  font-size:.72rem;font-weight:700;padding:.18rem .6rem;border-radius:50px;
}
.s-waiting{background:#fef3c7;color:#b45309;}
.s-serving{background:#dcfce7;color:#15803d;}
.s-done{background:#f1f5f9;color:#64748b;}
.s-skipped{background:#fee2e2;color:#b91c1c;}
.priority-pill{
  font-size:.62rem;font-weight:700;padding:.12rem .45rem;border-radius:50px;
  background:rgba(239,68,68,.1);color:#ef4444;border:1px solid rgba(239,68,68,.2);
  white-space:nowrap;
}
.pri-Senior{background:rgba(245,208,138,.15);color:#b45309;border-color:rgba(245,208,138,.4);}
.pri-Pregnant{background:rgba(249,168,212,.15);color:#be185d;border-color:rgba(249,168,212,.3);}
.pri-Disabled{background:rgba(147,197,253,.15);color:#1d4ed8;border-color:rgba(147,197,253,.3);}
.pri-Child{background:rgba(165,243,252,.15);color:#0369a1;border-color:rgba(165,243,252,.3);}
.pri-Critical{background:rgba(252,165,165,.15);color:#b91c1c;border-color:rgba(252,165,165,.3);}

.act-btns{display:flex;gap:.35rem;flex-wrap:nowrap;}
.ab{
  border:1.5px solid #e5e5e5;background:#fff;border-radius:8px;
  padding:.28rem .65rem;font-size:.72rem;font-weight:600;cursor:pointer;
  transition:all .15s;display:inline-flex;align-items:center;gap:.25rem;
  font-family:'DM Sans',sans-serif;color:var(--muted);
}
.ab:hover{border-color:var(--green);color:var(--green);}
.ab.serve{border-color:rgba(26,107,74,.3);color:var(--green);background:rgba(26,107,74,.04);}
.ab.serve:hover{background:var(--green);color:#fff;border-color:var(--green);}
.ab.done{border-color:rgba(34,197,94,.3);color:#15803d;}
.ab.done:hover{background:#15803d;color:#fff;border-color:#15803d;}
.ab.skip{border-color:rgba(220,38,38,.25);color:#b91c1c;}
.ab.skip:hover{background:#dc2626;color:#fff;border-color:#dc2626;}
.ab.back{border-color:rgba(100,116,139,.25);color:#64748b;}
.ab.back:hover{background:#64748b;color:#fff;border-color:#64748b;}
.ab.announce{border-color:rgba(139,92,246,.3);color:#7c3aed;background:rgba(139,92,246,.05);}
.ab.announce:hover{background:#7c3aed;color:#fff;border-color:#7c3aed;}
.ab.announce.playing{background:#7c3aed;color:#fff;border-color:#7c3aed;animation:pulse-btn .7s ease-in-out infinite;}
@keyframes pulse-btn{0%,100%{box-shadow:0 0 0 0 rgba(124,58,237,.4);}50%{box-shadow:0 0 0 6px rgba(124,58,237,0);}}

.empty-msg{text-align:center;padding:2.5rem;color:var(--muted);}
.empty-msg i{font-size:1.8rem;display:block;margin-bottom:.5rem;opacity:.25;}

/* filter row */
.filter-row{display:flex;gap:.5rem;flex-wrap:wrap;padding:.75rem 1rem;border-bottom:1px solid rgba(26,107,74,.06);}
.filter-chip{
  border:1.5px solid #e5e5e5;background:#fff;border-radius:50px;
  padding:.25rem .75rem;font-size:.73rem;font-weight:600;cursor:pointer;
  transition:all .15s;color:var(--muted);font-family:'DM Sans',sans-serif;
}
.filter-chip.active{border-color:var(--green);background:rgba(26,107,74,.06);color:var(--green);}

/* ─── SIDEBAR ─── */
.sidebar-col{display:flex;flex-direction:column;gap:1.2rem;}
.side-card{background:#fff;border-radius:var(--r);border:1px solid rgba(26,107,74,.1);box-shadow:0 2px 12px rgba(26,107,74,.04);overflow:hidden;}
.side-card-head{padding:.85rem 1.1rem;border-bottom:1px solid rgba(26,107,74,.08);font-size:.82rem;font-weight:700;display:flex;align-items:center;justify-content:space-between;gap:.5rem;color:var(--dark);}
.side-card-head i{color:var(--green);}
.side-card-body{padding:1rem 1.1rem;}

/* Quick add form */
.qaf .fg{display:flex;flex-direction:column;gap:.3rem;margin-bottom:.7rem;}
.qaf label{font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);}
.qaf input,.qaf select{
  width:100%;border:1.5px solid #e5e5e5;border-radius:9px;
  padding:.5rem .8rem;font-size:.82rem;font-family:'DM Sans',sans-serif;
  color:var(--text);background:#fff;transition:border-color .18s;
}
.qaf input:focus,.qaf select:focus{outline:none;border-color:var(--green);box-shadow:0 0 0 3px rgba(26,107,74,.09);}
.btn-add{
  width:100%;background:var(--green);color:#fff;border:none;border-radius:50px;
  padding:.6rem 1rem;font-size:.85rem;font-weight:700;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:.4rem;
  font-family:'DM Sans',sans-serif;transition:all .2s;margin-top:.3rem;
}
.btn-add:hover{background:var(--gl);transform:translateY(-1px);box-shadow:0 6px 18px rgba(26,107,74,.25);}

/* Session config */
.sess-cfg-item{
  display:flex;align-items:center;gap:.6rem;padding:.55rem 0;
  border-bottom:1px solid #f5f5f5;
}
.sess-cfg-item:last-child{border:none;}
.sci-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);flex-shrink:0;}
.sci-info{flex:1;min-width:0;}
.sci-name{font-size:.8rem;font-weight:600;color:var(--dark);}
.sci-time{font-size:.67rem;color:var(--muted);margin-top:1px;}
.sci-cap{
  font-family:'DM Mono',monospace;font-size:.72rem;color:var(--muted);
  background:#f5f5f5;border-radius:6px;padding:.12rem .4rem;flex-shrink:0;
}
.sci-cap.almost{color:#b45309;background:#fef3c7;}
.sci-cap.full{color:#b91c1c;background:#fee2e2;}

/* ─── MANAGE SESSIONS MODAL ─── */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:500;
  display:none;align-items:center;justify-content:center;padding:1rem;
}
.modal-overlay.open{display:flex;}
.modal{
  background:#fff;border-radius:20px;width:100%;max-width:540px;
  max-height:90vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,.2);
}
.modal-head{
  padding:1.2rem 1.5rem;border-bottom:1px solid #f0f0f0;
  display:flex;align-items:center;justify-content:space-between;
  font-size:1rem;font-weight:700;font-family:'Playfair Display',serif;
}
.modal-close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--muted);padding:.2rem;}
.modal-body{padding:1.4rem 1.5rem;}
.sess-edit-item{
  border:1.5px solid #e5e5e5;border-radius:12px;padding:1rem;margin-bottom:.75rem;
}
.sei-row{display:flex;gap:.6rem;margin-bottom:.6rem;}
.sei-row:last-child{margin:0;}
.sei-fg{flex:1;display:flex;flex-direction:column;gap:.25rem;}
.sei-fg label{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);}
.sei-fg input,.sei-fg select{
  width:100%;border:1.5px solid #e5e5e5;border-radius:8px;
  padding:.45rem .7rem;font-size:.82rem;font-family:'DM Sans',sans-serif;
  color:var(--text);transition:border-color .18s;
}
.sei-fg input:focus{outline:none;border-color:var(--green);}
.modal-foot{padding:1rem 1.5rem;border-top:1px solid #f0f0f0;display:flex;gap:.7rem;justify-content:flex-end;}
.btn-modal-save{background:var(--green);color:#fff;border:none;border-radius:50px;padding:.6rem 1.5rem;font-size:.85rem;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;transition:background .2s;}
.btn-modal-save:hover{background:var(--gl);}
.btn-modal-cancel{background:transparent;color:var(--muted);border:1.5px solid #e5e5e5;border-radius:50px;padding:.6rem 1.5rem;font-size:.85rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;}
.btn-modal-cancel:hover{border-color:var(--muted);}

/* ─── TOAST ─── */
.toast-wrap{position:fixed;bottom:1.5rem;right:1.5rem;z-index:999;display:flex;flex-direction:column;gap:.5rem;}
.toast{
  background:#1a1a1a;color:#fff;border-radius:12px;
  padding:.75rem 1.1rem;font-size:.82rem;font-weight:500;
  display:flex;align-items:center;gap:.6rem;
  box-shadow:0 8px 32px rgba(0,0,0,.2);
  animation:slide-in .25s ease;
}
.toast.green{background:#15803d;}
.toast.red{background:#b91c1c;}
@keyframes slide-in{from{transform:translateX(40px);opacity:0;}to{transform:translateX(0);opacity:1;}}

/* ─── MISC ─── */
.section-head{
  display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem;flex-wrap:wrap;gap:.5rem;
}
.section-label{font-size:.7rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);}
.btn-sm{
  background:transparent;border:1.5px solid #e5e5e5;border-radius:50px;
  padding:.3rem .85rem;font-size:.76rem;font-weight:600;cursor:pointer;
  color:var(--muted);font-family:'DM Sans',sans-serif;transition:all .2s;
  display:inline-flex;align-items:center;gap:.3rem;
}
.btn-sm:hover{border-color:var(--green);color:var(--green);}
.btn-sm.danger:hover{border-color:var(--red);color:var(--red);}

@media(max-width:640px){
  .wrap{padding:1rem 1rem 3rem;}
  .queue-table th:nth-child(4),.queue-table td:nth-child(4),
  .queue-table th:nth-child(5),.queue-table td:nth-child(5){display:none;}
}
</style>
</head>
<body>

<!-- TOAST CONTAINER -->
<div class="toast-wrap" id="toast-wrap"></div>

<!-- MANAGE SESSIONS MODAL -->
<div class="modal-overlay" id="sess-modal">
  <div class="modal">
    <div class="modal-head">
      <span><i class="bi bi-calendar-week" style="color:var(--green);margin-right:.4rem"></i>Manage Sessions</span>
      <button class="modal-close" onclick="closeSessModal()"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="modal-body" id="sess-modal-body"></div>
    <div class="modal-foot">
      <button class="btn-modal-cancel" onclick="closeSessModal()">Cancel</button>
      <button class="btn-modal-save" onclick="saveSessions()"><i class="bi bi-check-lg" style="margin-right:.3rem"></i>Save Changes</button>
    </div>
  </div>
</div>

<!-- TOPBAR -->
<nav class="topbar">
  <a class="brand" href="index.html">Dr.Harikrishnan<span>Queue Management</span></a>
  <div class="topbar-right">
    <div class="nav-pill">
      <a href="index.html">Home</a>
      <a href="token-patient.html">Patient</a>
      <a href="token-display.html">Display</a>
      <a href="token-admin.html" class="active">Admin</a>
    </div>
    <div id="admin-clock">--:--</div>
  </div>
</nav>

<div class="wrap">

  <!-- STATS BAR -->
  <div class="stats-bar" id="stats-bar">
    <div class="stat-box"><div class="sb-val green" id="sb-wait">0</div><div class="sb-lbl">Waiting</div></div>
    <div class="stat-box"><div class="sb-val" id="sb-serving" style="color:var(--sky)">--</div><div class="sb-lbl">Serving Now</div></div>
    <div class="stat-box"><div class="sb-val gold" id="sb-done">0</div><div class="sb-lbl">Completed</div></div>
    <div class="stat-box"><div class="sb-val red" id="sb-skip">0</div><div class="sb-lbl">Skipped</div></div>
    <div class="stat-box"><div class="sb-val" id="sb-total">0</div><div class="sb-lbl">Total Today</div></div>
  </div>

  <div class="body-grid">

    <!-- ─── MAIN ─── -->
    <div class="main-panel">

      <!-- SESSION TABS -->
      <div class="section-head">
        <div class="section-label"><i class="bi bi-calendar3" style="margin-right:.3rem"></i>Session</div>
        <button class="btn-sm" onclick="openSessModal()"><i class="bi bi-gear"></i>Configure Sessions</button>
      </div>
      <div class="sess-tabs" id="sess-tabs"></div>

      <!-- NOW SERVING -->
      <div id="serving-area"></div>

      <!-- QUEUE TABLE -->
      <div class="card">
        <div class="card-head">
          <div class="card-title"><i class="bi bi-list-ol"></i>Queue</div>
          <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
            <div class="search-box">
              <i class="bi bi-search"></i>
              <input type="text" id="search-inp" placeholder="Search name / token…" oninput="renderQueue()"/>
            </div>
            <button class="btn-sm danger" onclick="confirmClearDone()"><i class="bi bi-trash3"></i>Clear Done</button>
          </div>
        </div>
        <div class="filter-row" id="filter-row">
          <button class="filter-chip active" data-f="all" onclick="setFilter('all')">All</button>
          <button class="filter-chip" data-f="waiting" onclick="setFilter('waiting')">Waiting</button>
          <button class="filter-chip" data-f="serving" onclick="setFilter('serving')">Serving</button>
          <button class="filter-chip" data-f="done" onclick="setFilter('done')">Done</button>
          <button class="filter-chip" data-f="skipped" onclick="setFilter('skipped')">Skipped</button>
        </div>
        <div style="overflow-x:auto;">
          <table class="queue-table">
            <thead>
              <tr>
                <th>Token</th>
                <th>Patient</th>
                <th>Session</th>
                <th>Condition</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="queue-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ─── SIDEBAR ─── -->
    <div class="sidebar-col">

      <!-- Quick Add Patient -->
      <div class="side-card">
        <div class="side-card-head"><span><i class="bi bi-person-plus"></i>Quick Add Patient</span></div>
        <div class="side-card-body">
          <div class="qaf">
            <div class="fg"><label>Full Name *</label><input type="text" id="qa-name" placeholder="Patient name"/></div>
            <div class="fg"><label>Phone</label><input type="tel" id="qa-phone" placeholder="+91 00000 00000"/></div>
            <div class="fg"><label>Session *</label>
              <select id="qa-sess"><option value="">— Select session —</option></select>
            </div>
            <div class="fg"><label>Condition</label>
              <select id="qa-cond">
                <option value="">General</option>
                <option>Cancer Treatment</option><option>Parkinson's Disease</option>
                <option>Kidney Disease / CKD</option><option>Kidney Stones</option>
                <option>Dementia / Neurological</option><option>General Consultation</option>
                <option>Follow-up Visit</option><option>Other</option>
              </select>
            </div>
            <div class="fg"><label>Priority</label>
              <select id="qa-pri">
                <option value="None">None</option>
                <option>Senior Citizen</option><option>Differently Abled</option>
                <option>Pregnant</option><option>Child</option><option>Critical</option>
              </select>
            </div>
            <button class="btn-add" onclick="quickAdd()"><i class="bi bi-plus-circle"></i>Add to Queue</button>
          </div>
        </div>
      </div>

      <!-- Sessions overview -->
      <div class="side-card">
        <div class="side-card-head"><span><i class="bi bi-clock-history"></i>Sessions Today</span></div>
        <div class="side-card-body" style="padding-top:.5rem;padding-bottom:.5rem;">
          <div id="sess-overview"></div>
        </div>
      </div>

      <!-- Danger zone -->
      <div class="side-card">
        <div class="side-card-head" style="color:var(--red);"><span style="color:var(--red)"><i class="bi bi-exclamation-triangle"></i>Danger Zone</span></div>
        <div class="side-card-body" style="display:flex;flex-direction:column;gap:.6rem;">
          <button class="btn-sm danger" style="width:100%;justify-content:center" onclick="confirmResetDay()"><i class="bi bi-arrow-counterclockwise"></i>Reset Today's Queue</button>
          <p style="font-size:.69rem;color:var(--muted);line-height:1.5;">Clears all tokens for today. Sessions configuration is preserved.</p>
        </div>
      </div>
    </div>

  </div><!-- end body-grid -->
</div><!-- end wrap -->

<script>
(function(){
var TKEY='kin_tokens', SKEY='kin_sessions';
var DEFAULT_SESSIONS=[
  {id:'AM1',name:'Morning Session 1',time:'9:00 AM – 11:00 AM',icon:'bi-brightness-high-fill',cap:30,avg:4},
  {id:'AM2',name:'Morning Session 2',time:'11:00 AM – 1:00 PM', icon:'bi-sun-fill',            cap:25,avg:5},
  {id:'PM1',name:'Afternoon Session', time:'2:00 PM – 4:00 PM', icon:'bi-cloud-sun-fill',      cap:25,avg:5},
  {id:'PM2',name:'Evening Session',   time:'4:00 PM – 6:00 PM', icon:'bi-moon-stars-fill',     cap:20,avg:6}
];

function getSessions(){try{return JSON.parse(localStorage.getItem(SKEY))||DEFAULT_SESSIONS;}catch(e){return DEFAULT_SESSIONS;}}
function saveSessStore(arr){localStorage.setItem(SKEY,JSON.stringify(arr));}
function getTokens(){try{return JSON.parse(localStorage.getItem(TKEY))||[];}catch(e){return[];}}
function saveTokens(arr){localStorage.setItem(TKEY,JSON.stringify(arr));}
function todayStr(){return new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});}

var activeSessId='all';
var filterState='all';

/* ─── CLOCK ─── */
function tickClock(){
  var now=new Date();
  var h=now.getHours()%12||12;
  var m=String(now.getMinutes()).padStart(2,'0');
  var ampm=now.getHours()>=12?'PM':'AM';
  document.getElementById('admin-clock').textContent=h+':'+m+' '+ampm;
}
setInterval(tickClock,5000);tickClock();

/* ─── HELPERS ─── */
function nextTokenNum(){
  var toks=getTokens().filter(function(t){return t.date===todayStr();});
  var max=0;
  toks.forEach(function(t){var n=parseInt(t.tokenNum.replace('T-',''))||0;if(n>max)max=n;});
  return 'T-'+String(max+1).padStart(3,'0');
}
function priorityClass(p){
  var m={'Senior Citizen':'pri-Senior','Differently Abled':'pri-Disabled','Pregnant':'pri-Pregnant','Child':'pri-Child','Critical':'pri-Critical'};
  return m[p]||'';
}
function statusHtml(s){
  var m={waiting:'s-waiting',serving:'s-serving',done:'s-done',skipped:'s-skipped'};
  var ic={waiting:'bi-hourglass',serving:'bi-person-check-fill',done:'bi-check-circle-fill',skipped:'bi-skip-forward-fill'};
  return '<span class="status-dot '+(m[s]||'')+'"><i class="bi '+(ic[s]||'')+'"></i>'+s+'</span>';
}

/* ─── TOAST ─── */
function toast(msg,type){
  var w=document.getElementById('toast-wrap');
  var d=document.createElement('div');
  d.className='toast '+(type||'');
  d.innerHTML='<i class="bi '+(type==='green'?'bi-check-circle':'bi-info-circle')+'"></i>'+msg;
  w.appendChild(d);
  setTimeout(function(){d.remove();},2800);
}

/* ─── RENDER STATS ─── */
function renderStats(){
  var tday=todayStr();
  var toks=getTokens().filter(function(t){return t.date===tday;});
  var wait=0,done=0,skip=0,servTok=null;
  toks.forEach(function(t){
    if(t.status==='waiting')wait++;
    else if(t.status==='done')done++;
    else if(t.status==='skipped')skip++;
    else if(t.status==='serving')servTok=t;
  });
  document.getElementById('sb-wait').textContent=wait;
  document.getElementById('sb-done').textContent=done;
  document.getElementById('sb-skip').textContent=skip;
  document.getElementById('sb-total').textContent=toks.length;
  document.getElementById('sb-serving').textContent=servTok?servTok.tokenNum:'--';
}

/* ─── RENDER SESSION TABS ─── */
function renderSessTabs(){
  var ss=getSessions();
  var tday=todayStr();
  var toks=getTokens().filter(function(t){return t.date===tday;});
  var el=document.getElementById('sess-tabs');
  el.innerHTML='<button class="sess-tab'+(activeSessId==='all'?' active':'')+'" onclick="setSessTab(\'all\')">All <span class="cnt">'+toks.filter(function(t){return t.status==='waiting';}).length+'</span></button>';
  ss.forEach(function(s){
    var cnt=toks.filter(function(t){return t.sessionId===s.id&&t.status==='waiting';}).length;
    el.innerHTML+='<button class="sess-tab'+(activeSessId===s.id?' active':'')+'" onclick="setSessTab(\''+s.id+'\')">'+s.name+' <span class="cnt">'+cnt+'</span></button>';
  });
}

/* ─── RENDER SERVING BAR ─── */
function renderServingArea(){
  var tday=todayStr();
  var toks=getTokens().filter(function(t){return t.date===tday;});
  var serving=null;
  for(var i=0;i<toks.length;i++){if(toks[i].status==='serving'){serving=toks[i];break;}}
  var el=document.getElementById('serving-area');
  if(!serving){
    el.innerHTML='<div class="no-serving"><i class="bi bi-person-x"></i><span>No patient being served right now. Click <strong>Serve</strong> on any waiting token to begin.</span></div>';
    return;
  }
  el.innerHTML='<div class="serving-bar">'+
    '<div><div class="sb-label">Now Serving</div><div class="sb-tok">'+serving.tokenNum+'</div></div>'+
    '<div class="sb-info">'+
      '<div class="sb-patient">'+serving.name+'</div>'+
      '<div class="sb-detail">'+(serving.age?serving.age+' y · ':'')+serving.condition+' · '+serving.sessionName+'</div>'+
    '</div>'+
    '<div class="sb-actions">'+
      '<button class="btn-done" onclick="setStatus(\''+serving.id+'\',\'done\')"><i class="bi bi-check-circle-fill"></i>Done</button>'+
      '<button class="btn-skip" onclick="setStatus(\''+serving.id+'\',\'skipped\')"><i class="bi bi-skip-forward-fill"></i>Skip</button>'+
    '</div>'+
  '</div>';
}

/* ─── RENDER QUEUE TABLE ─── */
function renderQueue(){
  var tday=todayStr();
  var toks=getTokens().filter(function(t){return t.date===tday;});
  var q=document.getElementById('search-inp').value.trim().toLowerCase();
  /* filter by session */
  if(activeSessId!=='all') toks=toks.filter(function(t){return t.sessionId===activeSessId;});
  /* filter by status */
  if(filterState!=='all') toks=toks.filter(function(t){return t.status===filterState;});
  /* search */
  if(q) toks=toks.filter(function(t){return t.name.toLowerCase().indexOf(q)>-1||t.tokenNum.toLowerCase().indexOf(q)>-1;});
  /* sort: waiting first, then serving, done, skipped */
  var order={waiting:0,serving:1,done:2,skipped:3};
  toks.sort(function(a,b){return (order[a.status]||9)-(order[b.status]||9);});

  var tb=document.getElementById('queue-tbody');
  if(toks.length===0){
    tb.innerHTML='<tr><td colspan="7"><div class="empty-msg"><i class="bi bi-inbox"></i>No patients match this filter</div></td></tr>';
    return;
  }
  tb.innerHTML='';
  toks.forEach(function(t){
    var pri=t.priority&&t.priority!=='None';
    var acts='';
    if(t.status==='waiting'){
      var hasServing=getTokens().some(function(x){return x.date===tday&&x.status==='serving';});
      if(!hasServing) acts+='<button class="ab serve" onclick="setStatus(\''+t.id+'\',\'serving\')"><i class="bi bi-person-check"></i>Serve</button>';
      acts+='<button class="ab skip" onclick="setStatus(\''+t.id+'\',\'skipped\')"><i class="bi bi-skip-forward"></i>Skip</button>';
    } else if(t.status==='serving'){
      acts+='<button class="ab done" onclick="setStatus(\''+t.id+'\',\'done\')"><i class="bi bi-check"></i>Done</button>';
      acts+='<button class="ab skip" onclick="setStatus(\''+t.id+'\',\'skipped\')"><i class="bi bi-skip-forward"></i>Skip</button>';
    } else if(t.status==='skipped'){
      acts+='<button class="ab back" onclick="setStatus(\''+t.id+'\',\'waiting\')"><i class="bi bi-arrow-counterclockwise"></i>Re-queue</button>';
    }
    acts+='<button class="ab announce" id="ann-'+t.id+'" onclick="announceToken(\''+t.id+'\',\''+t.tokenNum+'\',\''+t.name.replace(/'/g,'').replace(/"/g,'')+'\',this)" title="Announce"><i class="bi bi-megaphone-fill"></i></button>';
    acts+='<button class="ab" onclick="removeToken(\''+t.id+'\')" title="Delete"><i class="bi bi-trash3"></i></button>';
    var tr=document.createElement('tr');
    tr.innerHTML='<td><span class="tok-badge">'+t.tokenNum+'</span></td>'+
      '<td style="font-weight:600;max-width:130px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="'+t.name+'">'+t.name+'<div style="font-size:.68rem;color:var(--muted);font-weight:400">'+(t.phone||'')+'</div></td>'+
      '<td style="font-size:.78rem;color:var(--muted)">'+t.sessionName+'</td>'+
      '<td style="font-size:.78rem;max-width:110px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="'+(t.condition||'')+'">'+( t.condition||'—')+'</td>'+
      '<td>'+(pri?'<span class="priority-pill '+priorityClass(t.priority)+'">'+t.priority+'</span>':'<span style="color:#ccc;font-size:.75rem">—</span>')+'</td>'+
      '<td>'+statusHtml(t.status)+'</td>'+
      '<td><div class="act-btns">'+acts+'</div></td>';
    tb.appendChild(tr);
  });
}

/* ─── RENDER SESSION OVERVIEW (sidebar) ─── */
function renderSessOverview(){
  var ss=getSessions();
  var tday=todayStr();
  var toks=getTokens().filter(function(t){return t.date===tday;});
  var el=document.getElementById('sess-overview');
  el.innerHTML='';
  ss.forEach(function(s){
    var cnt=toks.filter(function(t){return t.sessionId===s.id&&t.status==='waiting';}).length;
    var capClass=cnt>=s.cap?'full':cnt>=s.cap*.8?'almost':'';
    var d=document.createElement('div');
    d.className='sess-cfg-item';
    d.innerHTML='<div class="sci-dot" style="background:'+(cnt>0?'var(--green)':'#ddd')+'"></div>'+
      '<div class="sci-info"><div class="sci-name">'+s.name+'</div><div class="sci-time">'+s.time+'</div></div>'+
      '<div class="sci-cap '+capClass+'">'+cnt+'/'+s.cap+'</div>';
    el.appendChild(d);
  });

  /* populate quick-add session dropdown */
  var qa=document.getElementById('qa-sess');
  qa.innerHTML='<option value="">— Select session —</option>';
  ss.forEach(function(s){qa.innerHTML+='<option value="'+s.id+'">'+s.name+'</option>';});
}

/* ─── FULL RE-RENDER ─── */
function refresh(){
  renderStats();
  renderSessTabs();
  renderServingArea();
  renderQueue();
  renderSessOverview();
}

/* ─── TOKEN ACTIONS ─── */
window.setStatus=function(id,status){
  var toks=getTokens();
  /* if setting to serving, clear existing serving */
  if(status==='serving'){
    var tday=todayStr();
    toks.forEach(function(t){if(t.date===tday&&t.status==='serving')t.status='waiting';});
  }
  for(var i=0;i<toks.length;i++){if(toks[i].id===id){toks[i].status=status;break;}}
  saveTokens(toks);
  var msgs={serving:'Now serving token',done:'Marked as done',skipped:'Token skipped',waiting:'Returned to queue'};
  toast(msgs[status]||'Updated','green');
  refresh();
};

window.removeToken=function(id){
  if(!confirm('Remove this token?')) return;
  var toks=getTokens().filter(function(t){return t.id!==id;});
  saveTokens(toks);
  toast('Token removed');
  refresh();
};

/* ─── QUICK ADD ─── */
window.quickAdd=function(){
  var name=document.getElementById('qa-name').value.trim();
  var phone=document.getElementById('qa-phone').value.trim();
  var sessId=document.getElementById('qa-sess').value;
  var cond=document.getElementById('qa-cond').value;
  var pri=document.getElementById('qa-pri').value;
  if(!name){toast('Enter patient name','red');return;}
  if(!sessId){toast('Select a session','red');return;}
  var ss=getSessions();
  var sess=null;for(var i=0;i<ss.length;i++){if(ss[i].id===sessId){sess=ss[i];break;}}
  var toks=getTokens();
  var tday=todayStr();
  var todayToks=toks.filter(function(t){return t.date===tday;});
  var waitCount=todayToks.filter(function(t){return t.sessionId===sessId&&t.status==='waiting';}).length;
  var avg=sess?sess.avg:5;
  var newToken={
    id:'qa_'+Date.now(),
    tokenNum:nextTokenNum(),
    name:name,phone:phone,
    age:'',gender:'',
    condition:cond||'General Consultation',
    visitType:'Walk-in',
    priority:pri||'None',
    date:tday,
    sessionId:sessId,
    sessionName:sess?sess.name:'',
    estimatedTime:'~'+(waitCount*avg)+' min',
    notes:'',
    status:'waiting',
    createdAt:new Date().toISOString()
  };
  toks.push(newToken);
  saveTokens(toks);
  document.getElementById('qa-name').value='';
  document.getElementById('qa-phone').value='';
  document.getElementById('qa-sess').value='';
  document.getElementById('qa-cond').value='';
  document.getElementById('qa-pri').value='None';
  toast('Added '+newToken.tokenNum+' — '+name,'green');
  refresh();
};

/* ─── FILTERS ─── */
window.setSessTab=function(id){activeSessId=id;renderSessTabs();renderQueue();};
window.setFilter=function(f){
  filterState=f;
  document.querySelectorAll('.filter-chip').forEach(function(c){c.classList.toggle('active',c.getAttribute('data-f')===f);});
  renderQueue();
};

/* ─── CLEAR DONE ─── */
window.confirmClearDone=function(){
  if(!confirm('Remove all done & skipped tokens for today?')) return;
  var toks=getTokens().filter(function(t){return t.date!==todayStr()||( t.status!=='done'&&t.status!=='skipped');});
  saveTokens(toks);
  toast('Cleared completed tokens','green');
  refresh();
};

/* ─── RESET DAY ─── */
window.confirmResetDay=function(){
  if(!confirm('Reset ALL tokens for today? This cannot be undone.')) return;
  var toks=getTokens().filter(function(t){return t.date!==todayStr();});
  saveTokens(toks);
  toast('Today\'s queue has been reset');
  refresh();
};

/* ─── SESSION MODAL ─── */
window.openSessModal=function(){
  var ss=getSessions();
  var body=document.getElementById('sess-modal-body');
  body.innerHTML='';
  ss.forEach(function(s,i){
    var d=document.createElement('div');
    d.className='sess-edit-item';
    d.setAttribute('data-idx',i);
    d.innerHTML=
      '<div class="sei-row">'+
        '<div class="sei-fg"><label>Session Name</label><input type="text" data-f="name" value="'+s.name+'"/></div>'+
        '<div class="sei-fg"><label>Time</label><input type="text" data-f="time" value="'+s.time+'"/></div>'+
      '</div>'+
      '<div class="sei-row">'+
        '<div class="sei-fg"><label>Capacity</label><input type="number" data-f="cap" value="'+s.cap+'" min="1" max="200"/></div>'+
        '<div class="sei-fg"><label>Avg Min / Patient</label><input type="number" data-f="avg" value="'+s.avg+'" min="1" max="60"/></div>'+
      '</div>';
    body.appendChild(d);
  });
  document.getElementById('sess-modal').classList.add('open');
};
window.closeSessModal=function(){document.getElementById('sess-modal').classList.remove('open');};
window.saveSessions=function(){
  var ss=getSessions();
  document.querySelectorAll('#sess-modal-body .sess-edit-item').forEach(function(d,i){
    if(!ss[i]) return;
    d.querySelectorAll('input').forEach(function(inp){
      var f=inp.getAttribute('data-f');
      if(f==='cap'||f==='avg') ss[i][f]=parseInt(inp.value)||ss[i][f];
      else ss[i][f]=inp.value;
    });
  });
  saveSessStore(ss);
  closeSessModal();
  toast('Sessions saved','green');
  refresh();
};

/* ─── ANNOUNCE (Web Speech API + localStorage broadcast) ─── */
var AKEY='kin_announce';

window.announceToken=function(id,tokenNum,name,btn){
  /* Write trigger to localStorage so token-display picks it up */
  var payload={tokenNum:tokenNum,name:name,ts:Date.now()};
  localStorage.setItem(AKEY,JSON.stringify(payload));

  /* Also speak locally on this tab using Web Speech API */
  speakAnnouncement(tokenNum,name,btn);
};

function speakAnnouncement(tokenNum,name,btn){
  if(!window.speechSynthesis){toast('Speech not supported in this browser','red');return;}

  window.speechSynthesis.cancel(); /* stop any current speech */

  /* Build text: spell out token number naturally */
  var numPart=tokenNum.replace('T-','').replace(/^0+/,''); /* "042" → "42" */
  var text='Token number '+numPart+'. '+name+', please proceed to the consultation room. Token number '+numPart+'.';

  var utter=new SpeechSynthesisUtterance(text);
  utter.rate=0.88;
  utter.pitch=1.1;
  utter.volume=1;
  utter.lang='en-IN';

  /* Pick a female voice — prefer en-IN, fallback to any female */
  function pickVoice(){
    var voices=window.speechSynthesis.getVoices();
    var female=null;
    /* Priority 1: en-IN female */
    for(var i=0;i<voices.length;i++){
      if(voices[i].lang&&voices[i].lang.indexOf('en-IN')>-1&&voices[i].name.toLowerCase().indexOf('female')>-1){female=voices[i];break;}
    }
    /* Priority 2: any en-IN */
    if(!female){for(var i=0;i<voices.length;i++){if(voices[i].lang&&voices[i].lang.indexOf('en-IN')>-1){female=voices[i];break;}}}
    /* Priority 3: female in name */
    if(!female){for(var i=0;i<voices.length;i++){if(voices[i].name.toLowerCase().indexOf('female')>-1){female=voices[i];break;}}}
    /* Priority 4: well-known female voice names */
    var femaleNames=['Samantha','Victoria','Karen','Moira','Tessa','Veena','Zira','Susan','Heera','Raveena','Aditi','Lekha'];
    if(!female){for(var i=0;i<voices.length;i++){for(var j=0;j<femaleNames.length;j++){if(voices[i].name.indexOf(femaleNames[j])>-1){female=voices[i];break;}}if(female)break;}}
    /* Priority 5: first English voice */
    if(!female){for(var i=0;i<voices.length;i++){if(voices[i].lang&&voices[i].lang.indexOf('en')>-1){female=voices[i];break;}}}
    return female;
  }

  function startSpeech(){
    var v=pickVoice();
    if(v) utter.voice=v;
    if(btn){btn.classList.add('playing');btn.innerHTML='<i class="bi bi-volume-up-fill"></i>';}
    utter.onend=function(){
      if(btn){btn.classList.remove('playing');btn.innerHTML='<i class="bi bi-megaphone-fill"></i>';}
    };
    utter.onerror=function(){
      if(btn){btn.classList.remove('playing');btn.innerHTML='<i class="bi bi-megaphone-fill"></i>';}
    };
    window.speechSynthesis.speak(utter);
  }

  /* Voices may not be loaded yet */
  if(window.speechSynthesis.getVoices().length===0){
    window.speechSynthesis.onvoiceschanged=function(){startSpeech();window.speechSynthesis.onvoiceschanged=null;};
  } else {
    startSpeech();
  }
}

/* ─── STORAGE EVENTS (cross-tab) ─── */
window.addEventListener('storage',function(e){if(e.key===TKEY||e.key===SKEY)refresh();});

/* ─── INIT ─── */
refresh();
setInterval(refresh,8000);
})();
</script>
</body>
</html>
